<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Document Assistant Pro | AI-Powered Document Analysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'] 
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'slide-in-left': 'slideInLeft 0.3s ease-out',
            'slide-in-right': 'slideInRight 0.3s ease-out',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            slideInLeft: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(0)' }
            },
            slideInRight: {
              '0%': { transform: 'translateX(100%)' },
              '100%': { transform: 'translateX(0)' }
            },
            shimmer: {
              '0%': { backgroundPosition: '-1000px 0' },
              '100%': { backgroundPosition: '1000px 0' }
            }
          }
        }
      }
    }
  </script>

  <style>
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      overflow: hidden;
    }

    .dark body { 
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .dark .glass-effect {
      background: rgba(15, 23, 42, 0.95);
    }

    .message-bubble { 
      max-width: 85%; 
      line-height: 1.6;
      animation: fade-in 0.3s ease-in-out;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (min-width: 768px) {
      .message-bubble {
        max-width: 80%;
      }
    }

    .scrollbar-custom::-webkit-scrollbar { 
      width: 4px; 
    }

    .scrollbar-custom::-webkit-scrollbar-track { 
      background: transparent; 
    }

    .scrollbar-custom::-webkit-scrollbar-thumb { 
      background: #cbd5e1; 
      border-radius: 999px; 
    }

    .scrollbar-custom::-webkit-scrollbar-thumb:hover { 
      background: #94a3b8; 
    }

    .dark .scrollbar-custom::-webkit-scrollbar-thumb { 
      background: #475569; 
    }

    .dark .scrollbar-custom::-webkit-scrollbar-thumb:hover { 
      background: #64748b; 
    }

    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #64748b;
      animation: pulse 1.4s ease-in-out infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    .document-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      color: #3b82f6;
      margin: 2px;
      transition: all 0.2s;
      position: relative;
    }

    @media (min-width: 768px) {
      .document-badge {
        padding: 6px 12px;
        font-size: 13px;
        gap: 6px;
        border-radius: 8px;
        margin: 4px;
      }
    }

    .document-badge:hover {
      background: rgba(59, 130, 246, 0.15);
      transform: translateY(-1px);
    }

    .document-badge:hover .doc-actions {
      opacity: 1;
      pointer-events: auto;
    }

    .dark .document-badge {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .doc-actions {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .session-item {
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }

    .session-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .session-item:hover .session-actions {
      opacity: 1;
    }

    .session-item.active {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), transparent);
      border-left: 3px solid #3b82f6;
    }

    .session-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }

    /* Mobile Sidebar Overlay */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
      transition: opacity 0.3s;
    }

    .sidebar-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Sidebar for Mobile */
    .sidebar {
      transition: transform 0.3s ease-in-out;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 85%;
      max-width: 320px;
      z-index: 50;
      transform: translateX(-100%);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    @media (min-width: 768px) {
      .sidebar {
        position: relative;
        width: 320px;
        transform: translateX(0);
      }
      
      .sidebar-overlay {
        display: none;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fade-in 0.2s ease-in-out;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slide-up 0.3s ease-out;
    }

    .dark .modal-content {
      background: #1e293b;
    }

    .tooltip {
      position: relative;
    }

    @media (min-width: 768px) {
      .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 12px;
        background: #1e293b;
        color: white;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        margin-bottom: 8px;
        opacity: 0;
        animation: fade-in 0.2s ease-in-out forwards;
        z-index: 1000;
        pointer-events: none;
      }
    }

    /* Mobile optimizations */
    @media (max-width: 767px) {
      .message-bubble {
        font-size: 14px;
      }
      
      .chat-container {
        height: 100vh;
        height: -webkit-fill-available;
      }
    }

    /* Prevent text selection on buttons */
    button {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* Better touch targets for mobile */
    @media (max-width: 767px) {
      button {
        min-width: 44px;
        min-height: 44px;
      }
    }

    /* Dropdown menu */
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      z-index: 50;
      animation: slide-up 0.2s ease-out;
    }

    .dropdown-menu.active {
      display: block;
    }

    .dark .dropdown-menu {
      background: #1e293b;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body class="antialiased">

  <!-- Sidebar Overlay (Mobile) -->
  <div id="sidebarOverlay" class="sidebar-overlay hidden"></div>

  <div class="chat-container w-full h-screen flex glass-effect md:m-4 md:rounded-2xl md:shadow-2xl border-0 md:border md:border-white/20 dark:md:border-slate-700/50 overflow-hidden md:max-w-7xl md:mx-auto md:h-[98vh]">

    <!-- Sidebar - Chat Sessions -->
    <div id="sidebar" class="sidebar border-r border-slate-200/50 dark:border-slate-700/50 flex flex-col bg-white dark:bg-slate-900 md:bg-white/50 md:dark:bg-slate-900/50 backdrop-blur-sm">
      
      <!-- Sidebar Header -->
      <div class="p-3 md:p-4 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between gap-2">
        <button id="newChatBtn" class="flex-1 px-3 md:px-4 py-2.5 md:py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-medium hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
          <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          <span class="hidden sm:inline">New Chat</span>
          <span class="sm:hidden">New</span>
        </button>
        
        <!-- Close button for mobile -->
        <button id="closeSidebar" class="md:hidden p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
          <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Sessions List -->
      <div class="flex-1 overflow-y-auto scrollbar-custom p-2 md:p-3">
        <div id="sessionsList" class="space-y-1.5 md:space-y-2">
          <!-- Sessions will be loaded here -->
        </div>
        
        <!-- Empty state -->
        <div id="emptySessionsState" class="flex flex-col items-center justify-center h-full text-center p-4 md:p-6">
          <svg class="w-12 h-12 md:w-16 md:h-16 text-slate-300 dark:text-slate-600 mb-3 md:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
          </svg>
          <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400">No chat sessions yet</p>
          <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">Start a new conversation!</p>
        </div>
      </div>

      <!-- User Profile -->
      <div class="p-3 md:p-4 border-t border-slate-200/50 dark:border-slate-700/50">
        <div class="flex items-center gap-2 md:gap-3">
          <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-slate-300 to-slate-400 dark:from-slate-600 dark:to-slate-700 flex items-center justify-center flex-shrink-0 cursor-pointer hover:shadow-lg transition" id="profileBtn">
            <svg class="w-4 h-4 md:w-5 md:h-5 text-slate-700 dark:text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0 cursor-pointer" id="profileInfo">
            <p id="userName" class="text-xs md:text-sm font-medium text-slate-900 dark:text-white truncate">User</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Online</p>
          </div>
          <button id="logoutBtn" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition flex-shrink-0 tooltip" data-tooltip="Logout">
            <svg class="w-4 h-4 md:w-5 md:h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col min-w-0">

      <!-- Header -->
      <div class="px-3 py-3 md:px-6 md:py-5 border-b border-slate-200/50 dark:border-slate-700/50 bg-gradient-to-r from-white/50 to-transparent dark:from-slate-800/50 flex-shrink-0">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 md:gap-4 flex-1 min-w-0">
            <!-- Mobile menu toggle -->
            <button id="mobileMenuToggle" class="md:hidden p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition flex-shrink-0">
              <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>

            <div class="relative flex-shrink-0">
              <div class="w-9 h-9 md:w-12 md:h-12 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg md:text-xl shadow-lg">
                <svg class="w-5 h-5 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 md:w-4 md:h-4 bg-green-500 rounded-full border-2 border-white dark:border-slate-900"></div>
            </div>
            
            <div class="min-w-0 flex-1">
              <h1 id="chatTitle" class="font-bold text-sm md:text-xl text-slate-900 dark:text-white truncate cursor-pointer hover:text-blue-600 transition" title="Click to rename">Document Assistant</h1>
              <p class="text-xs text-slate-600 dark:text-slate-400 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span class="hidden sm:inline">AI-Powered Analysis •</span> Online
              </p>
            </div>
          </div>

          <div class="flex items-center gap-1 md:gap-2 flex-shrink-0">
            <!-- Documents Count Badge -->
            <button id="docCount" class="hidden px-2 py-1 md:px-3 md:py-1.5 bg-blue-50 dark:bg-blue-950/30 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-950/50 transition tooltip" data-tooltip="View documents">
              <span class="text-xs font-semibold text-blue-600 dark:text-blue-400">
                <span id="docCountNumber">0</span> docs
              </span>
            </button>

            <!-- Theme Toggle -->
            <button id="themeToggle" class="p-2 md:p-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition tooltip" data-tooltip="Toggle theme">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
              </svg>
            </button>

            <!-- More Options (Dropdown) -->
            <div class="relative">
              <button id="moreOptionsBtn" class="p-2 md:p-2.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition tooltip" data-tooltip="More options">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
              
              <!-- Dropdown Menu -->
              <div id="moreOptionsMenu" class="dropdown-menu">
                <div class="py-2">
                  <button onclick="renameSession()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Rename Session
                  </button>
                  <button onclick="exportChat()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export Chat
                  </button>
                  <button onclick="clearConversation()" class="w-full px-4 py-2 text-left text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-3">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear Messages
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Uploaded Documents Display -->
        <div id="uploadedDocs" class="mt-3 md:mt-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-slate-500 dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              <span class="text-xs font-medium text-slate-600 dark:text-slate-400">Documents in this session:</span>
            </div>
            <button onclick="openDocumentManager()" class="text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 font-medium">
              Manage
            </button>
          </div>
          <div id="docsList" class="flex flex-wrap gap-1 md:gap-2"></div>
        </div>
      </div>

      <!-- Messages Area -->
      <div id="messages" class="flex-1 overflow-y-auto px-3 py-4 md:px-6 md:py-6 space-y-3 md:space-y-5 scrollbar-custom">
        
        <!-- Welcome Message -->
        <div class="flex items-start gap-2 md:gap-4 animate-fade-in">
          <div class="w-9 h-9 md:w-11 md:h-11 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex-shrink-0 flex items-center justify-center text-white shadow-md">
            <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div class="flex-1 bg-white dark:bg-slate-800 px-4 py-3 md:px-6 md:py-4 rounded-2xl rounded-tl-md shadow-sm border border-slate-100 dark:border-slate-700">
            <p class="text-slate-800 dark:text-slate-200 text-sm md:text-base mb-1 md:mb-2">Welcome! I'm your AI Document Assistant.</p>
            <p class="text-xs md:text-sm text-slate-600 dark:text-slate-400">
              Upload your documents and start asking questions to get instant, accurate answers.
            </p>
          </div>
        </div>

      </div>

      <!-- Input Area -->
      <div class="border-t border-slate-200/50 dark:border-slate-700/50 bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm px-3 py-3 md:px-6 md:py-4 flex-shrink-0 safe-area-bottom">
        
        <form id="chat-form" class="flex items-end gap-2 md:gap-3">
          <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.txt" multiple/>
          
          <!-- Upload button -->
          <button type="button" id="uploadBtn" class="p-2.5 md:p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 transition-all hover:shadow-md flex-shrink-0 tooltip" data-tooltip="Upload documents">
            <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
            </svg>
          </button>

          <!-- Input field -->
          <div class="flex-1 relative min-w-0">
            <textarea
              id="question"
              rows="1"
              placeholder="Ask about your documents..."
              class="w-full resize-none rounded-xl px-4 py-3 md:px-5 md:py-3.5 pr-10 md:pr-12 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 shadow-sm text-sm md:text-base"
              maxlength="2000"
            ></textarea>
            <div class="absolute right-2 md:right-3 bottom-2 md:bottom-3 text-xs text-slate-400 dark:text-slate-500 pointer-events-none">
              <span id="charCount">0</span>/2k
            </div>
          </div>

          <!-- Send button -->
          <button
            type="submit"
            id="send-btn"
            class="p-3 md:p-3.5 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md active:scale-95 disabled:active:scale-100 flex-shrink-0"
            disabled
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </form>

        <!-- Footer info -->
        <div class="mt-2 md:mt-3 flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
          <p class="flex items-center gap-1.5 md:gap-2">
            <svg class="w-3 h-3 md:w-3.5 md:h-3.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <span class="hidden sm:inline">AI responses may contain inaccuracies</span>
            <span class="sm:hidden">Verify AI responses</span>
          </p>
          <p class="hidden md:block">Press <kbd class="px-1.5 py-0.5 bg-slate-200 dark:bg-slate-700 rounded text-xs">Enter</kbd></p>
        </div>
      </div>

    </div>
  </div>

  <!-- Document Manager Modal -->
  <div id="documentManagerModal" class="modal">
    <div class="modal-content">
      <div class="p-4 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg md:text-xl font-bold text-slate-900 dark:text-white">Document Manager</h2>
          <button onclick="closeDocumentManager()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
            <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="documentManagerList" class="space-y-3">
          <!-- Documents will be listed here -->
        </div>

        <div class="mt-6 flex gap-3">
          <button onclick="document.getElementById('fileInput').click(); closeDocumentManager();" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium text-sm flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Add New Document
          </button>
          <button onclick="closeDocumentManager()" class="px-4 py-2.5 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition font-medium text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="p-4 md:p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg md:text-xl font-bold text-slate-900 dark:text-white">Profile Settings</h2>
          <button onclick="closeProfileModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
            <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-6">
          <!-- Profile Avatar -->
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-slate-300 to-slate-400 dark:from-slate-600 dark:to-slate-700 flex items-center justify-center">
              <svg class="w-10 h-10 text-slate-700 dark:text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
            </div>
            <div>
              <h3 id="profileName" class="font-semibold text-slate-900 dark:text-white">User</h3>
              <p id="profileEmail" class="text-sm text-slate-600 dark:text-slate-400">user@example.com</p>
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-3">
            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg text-center">
              <p class="text-2xl font-bold text-blue-600" id="totalSessions">0</p>
              <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Sessions</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg text-center">
              <p class="text-2xl font-bold text-green-600" id="totalDocuments">0</p>
              <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Documents</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg text-center">
              <p class="text-2xl font-bold text-purple-600" id="totalMessages">0</p>
              <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Messages</p>
            </div>
          </div>

          <!-- Actions -->
          <div class="space-y-2">
            <button onclick="exportAllChats()" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition text-left flex items-center gap-3">
              <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              <span class="text-slate-900 dark:text-white">Export All Chats</span>
            </button>
            <button onclick="clearAllData()" class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-red-200 dark:border-red-800 rounded-lg hover:bg-red-50 dark:hover:bg-red-950/30 transition text-left flex items-center gap-3">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              <span class="text-red-600">Clear All Data</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Session Modal -->
  <div id="renameModal" class="modal">
    <div class="modal-content max-w-md">
      <div class="p-4 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-slate-900 dark:text-white">Rename Session</h2>
          <button onclick="closeRenameModal()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
            <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <input 
          type="text" 
          id="newSessionName" 
          placeholder="Enter new session name..."
          class="w-full px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none"
        />

        <div class="mt-6 flex gap-3">
          <button onclick="saveSessionRename()" class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
            Save
          </button>
          <button onclick="closeRenameModal()" class="px-4 py-2.5 bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition font-medium">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed top-4 right-4 left-4 md:left-auto md:top-6 md:right-6 bg-slate-900 text-white px-4 py-3 md:px-6 md:py-3 rounded-xl shadow-2xl z-[60] animate-slide-up">
    <div class="flex items-center gap-3">
      <svg id="toastIcon" class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
      <span id="toastMessage" class="font-medium text-sm md:text-base"></span>
    </div>
  </div>

  <script>
    // ══════════════════════════════════════════════════════════════════════════════
    // STATE MANAGEMENT
    // ══════════════════════════════════════════════════════════════════════════════
    
    const AppState = {
      currentSessionId: null,
      uploadedDocuments: [],
      sessions: [],
      isProcessing: false,
      theme: localStorage.getItem('theme') || 'light',
      isMobile: window.innerWidth < 768
    };

    // ══════════════════════════════════════════════════════════════════════════════
    // DOM ELEMENTS
    // ══════════════════════════════════════════════════════════════════════════════
    
    const elements = {
      form: document.getElementById('chat-form'),
      input: document.getElementById('question'),
      sendBtn: document.getElementById('send-btn'),
      messages: document.getElementById('messages'),
      fileInput: document.getElementById('fileInput'),
      uploadBtn: document.getElementById('uploadBtn'),
      uploadedDocs: document.getElementById('uploadedDocs'),
      docsList: document.getElementById('docsList'),
      docCount: document.getElementById('docCount'),
      docCountNumber: document.getElementById('docCountNumber'),
      charCount: document.getElementById('charCount'),
      themeToggle: document.getElementById('themeToggle'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toastMessage'),
      toastIcon: document.getElementById('toastIcon'),
      newChatBtn: document.getElementById('newChatBtn'),
      sessionsList: document.getElementById('sessionsList'),
      emptySessionsState: document.getElementById('emptySessionsState'),
      chatTitle: document.getElementById('chatTitle'),
      logoutBtn: document.getElementById('logoutBtn'),
      userName: document.getElementById('userName'),
      sidebar: document.getElementById('sidebar'),
      sidebarOverlay: document.getElementById('sidebarOverlay'),
      mobileMenuToggle: document.getElementById('mobileMenuToggle'),
      closeSidebar: document.getElementById('closeSidebar'),
      moreOptionsBtn: document.getElementById('moreOptionsBtn'),
      moreOptionsMenu: document.getElementById('moreOptionsMenu'),
      documentManagerModal: document.getElementById('documentManagerModal'),
      documentManagerList: document.getElementById('documentManagerList'),
      profileModal: document.getElementById('profileModal'),
      profileBtn: document.getElementById('profileBtn'),
      profileInfo: document.getElementById('profileInfo'),
      renameModal: document.getElementById('renameModal'),
      newSessionName: document.getElementById('newSessionName')
    };

    // ══════════════════════════════════════════════════════════════════════════════
    // INITIALIZATION
    // ══════════════════════════════════════════════════════════════════════════════
    
    async function init() {
      applyTheme(AppState.theme);
      setupEventListeners();
      await loadSessions();
      elements.input.focus();
      
      // Get CSRF token
      const csrfToken = getCookie('csrftoken');
      if (csrfToken) {
        AppState.csrfToken = csrfToken;
      }

      // Handle window resize
      window.addEventListener('resize', () => {
        AppState.isMobile = window.innerWidth < 768;
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#moreOptionsBtn') && !e.target.closest('#moreOptionsMenu')) {
          elements.moreOptionsMenu.classList.remove('active');
        }
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // SIDEBAR MOBILE CONTROLS
    // ══════════════════════════════════════════════════════════════════════════════

    function openSidebar() {
      elements.sidebar.classList.add('open');
      elements.sidebarOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      elements.sidebar.classList.remove('open');
      elements.sidebarOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // MODAL CONTROLS
    // ══════════════════════════════════════════════════════════════════════════════

    function openDocumentManager() {
      elements.documentManagerModal.classList.add('active');
      renderDocumentManager();
    }

    function closeDocumentManager() {
      elements.documentManagerModal.classList.remove('active');
    }

    function openProfileModal() {
      elements.profileModal.classList.add('active');
      updateProfileStats();
    }

    function closeProfileModal() {
      elements.profileModal.classList.remove('active');
    }

    function openRenameModal() {
      const currentTitle = elements.chatTitle.textContent;
      elements.newSessionName.value = currentTitle;
      elements.renameModal.classList.add('active');
      setTimeout(() => elements.newSessionName.select(), 100);
    }

    function closeRenameModal() {
      elements.renameModal.classList.remove('active');
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // DOCUMENT MANAGER
    // ══════════════════════════════════════════════════════════════════════════════

    function renderDocumentManager() {
      if (AppState.uploadedDocuments.length === 0) {
        elements.documentManagerList.innerHTML = `
          <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-slate-300 dark:text-slate-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
            </svg>
            <p class="text-slate-600 dark:text-slate-400 text-sm">No documents uploaded yet</p>
          </div>
        `;
        return;
      }

      elements.documentManagerList.innerHTML = AppState.uploadedDocuments.map((doc, index) => `
        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
          <div class="flex items-start justify-between gap-3">
            <div class="flex items-start gap-3 flex-1 min-w-0">
              <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-slate-900 dark:text-white text-sm truncate">${escapeHtml(doc.name)}</h4>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                  ${doc.size} MB • Uploaded ${formatDate(doc.uploadedAt)}
                </p>
              </div>
            </div>
            <button onclick="deleteDocument(${index})" class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition flex-shrink-0">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    function deleteDocument(index) {
      if (!confirm('Delete this document? This action cannot be undone.')) {
        return;
      }

      const doc = AppState.uploadedDocuments[index];
      AppState.uploadedDocuments.splice(index, 1);
      updateDocumentsList();
      renderDocumentManager();
      showToast('success', `${doc.name} removed`);
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // PROFILE & STATS
    // ══════════════════════════════════════════════════════════════════════════════

    function updateProfileStats() {
      document.getElementById('totalSessions').textContent = AppState.sessions.length;
      document.getElementById('totalDocuments').textContent = AppState.uploadedDocuments.length;
      
      let totalMessages = 0;
      AppState.sessions.forEach(session => {
        totalMessages += session.message_count || 0;
      });
      document.getElementById('totalMessages').textContent = totalMessages;
    }

    function exportAllChats() {
      showToast('info', 'Exporting all chats...');
      // Implementation for export
      setTimeout(() => {
        showToast('success', 'All chats exported successfully');
      }, 1000);
    }

    function clearAllData() {
      if (!confirm('This will delete ALL your chat sessions and documents. This action cannot be undone. Are you sure?')) {
        return;
      }

      AppState.sessions = [];
      AppState.uploadedDocuments = [];
      AppState.currentSessionId = null;
      
      renderSessions();
      clearMessages();
      addWelcomeMessage();
      updateDocumentsList();
      closeProfileModal();
      
      showToast('success', 'All data cleared');
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // SESSION RENAME
    // ══════════════════════════════════════════════════════════════════════════════

    function renameSession() {
      elements.moreOptionsMenu.classList.remove('active');
      openRenameModal();
    }

    async function saveSessionRename() {
      const newName = elements.newSessionName.value.trim();
      
      if (!newName) {
        showToast('error', 'Session name cannot be empty');
        return;
      }

      if (!AppState.currentSessionId) {
        showToast('error', 'No active session');
        return;
      }

      try {
        const response = await fetch(`/api/chat/sessions/${AppState.currentSessionId}/title/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ title: newName })
        });

        if (!response.ok) throw new Error('Failed to rename session');

        const data = await response.json();
        elements.chatTitle.textContent = data.title;
        
        // Update in sessions list
        await loadSessions();
        
        closeRenameModal();
        showToast('success', 'Session renamed');
        
      } catch (error) {
        console.error('Error renaming session:', error);
        showToast('error', 'Failed to rename session');
      }
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // EXPORT CHAT
    // ══════════════════════════════════════════════════════════════════════════════

    function exportChat() {
      elements.moreOptionsMenu.classList.remove('active');
      
      // Get all messages from the current session
      const messagesContainer = document.getElementById('messages');
      const messages = messagesContainer.querySelectorAll('.message-bubble');
      
      let exportText = `Chat Session: ${elements.chatTitle.textContent}\n`;
      exportText += `Exported: ${new Date().toLocaleString()}\n`;
      exportText += `${'='.repeat(60)}\n\n`;
      
      messages.forEach(bubble => {
        const role = bubble.closest('.justify-end') ? 'User' : 'Assistant';
        const content = bubble.querySelector('.prose').textContent.trim();
        exportText += `${role}:\n${content}\n\n`;
      });
      
      // Create and download file
      const blob = new Blob([exportText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat-${AppState.currentSessionId || 'export'}-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('success', 'Chat exported successfully');
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // SESSION MANAGEMENT
    // ══════════════════════════════════════════════════════════════════════════════

    async function loadSessions() {
      try {
        const response = await fetch('/api/chat/sessions/');
        if (!response.ok) throw new Error('Failed to load sessions');
        
        const data = await response.json();
        AppState.sessions = data.sessions || [];
        
        renderSessions();
        
        // Load the most recent session if exists
        if (AppState.sessions.length > 0 && !AppState.currentSessionId) {
          await loadSession(AppState.sessions[0].id);
        }
      } catch (error) {
        console.error('Error loading sessions:', error);
      }
    }

    function renderSessions() {
      if (AppState.sessions.length === 0) {
        elements.emptySessionsState.classList.remove('hidden');
        elements.sessionsList.innerHTML = '';
        return;
      }

      elements.emptySessionsState.classList.add('hidden');
      
      elements.sessionsList.innerHTML = AppState.sessions.map(session => `
        <div class="session-item ${session.id === AppState.currentSessionId ? 'active' : ''} p-2.5 md:p-3 rounded-lg" data-session-id="${session.id}">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <h3 class="text-xs md:text-sm font-medium text-slate-900 dark:text-white truncate">${escapeHtml(session.title)}</h3>
              <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5 md:mt-1 truncate">
                ${session.last_message || 'No messages yet'}
              </p>
              <div class="flex items-center gap-1.5 md:gap-2 mt-0.5 md:mt-1">
                <span class="text-xs text-slate-400 dark:text-slate-500">${formatDate(session.updated_at)}</span>
                <span class="text-xs text-slate-400 dark:text-slate-500">•</span>
                <span class="text-xs text-slate-400 dark:text-slate-500">${session.message_count} msgs</span>
              </div>
            </div>
            <div class="session-actions flex items-center gap-1 flex-shrink-0">
              <button onclick="deleteSession('${session.id}', event)" class="p-1.5 rounded hover:bg-red-50 dark:hover:bg-red-950/30 text-slate-400 hover:text-red-600 transition">
                <svg class="w-3.5 h-3.5 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');

      // Add click handlers
      document.querySelectorAll('.session-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            loadSession(item.dataset.sessionId);
            if (AppState.isMobile) {
              closeSidebar();
            }
          }
        });
      });
    }

    async function createNewSession() {
      try {
        const response = await fetch('/api/chat/sessions/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: `Chat - ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`
          })
        });

        if (!response.ok) throw new Error('Failed to create session');
        
        const session = await response.json();
        AppState.currentSessionId = session.session_id;
        
        // Clear current chat
        clearMessages();
        
        // Add welcome message
        addWelcomeMessage();
        
        // Clear documents
        AppState.uploadedDocuments = [];
        updateDocumentsList();
        
        // Update title
        elements.chatTitle.textContent = session.title;
        
        // Reload sessions list
        await loadSessions();
        
        showToast('success', 'New chat created');
        
        // Close sidebar on mobile
        if (AppState.isMobile) {
          closeSidebar();
        }
        
      } catch (error) {
        console.error('Error creating session:', error);
        showToast('error', 'Failed to create new chat');
      }
    }

    async function loadSession(sessionId) {
      try {
        const response = await fetch(`/api/chat/sessions/${sessionId}/`);
        if (!response.ok) throw new Error('Failed to load session');
        
        const data = await response.json();
        
        AppState.currentSessionId = sessionId;
        elements.chatTitle.textContent = data.title;
        
        // Clear current messages
        clearMessages();
        
        // Load documents
        AppState.uploadedDocuments = data.documents || [];
        updateDocumentsList();
        
        // Load messages
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            addMessage(msg.role, msg.content, { skipSave: true });
          });
        } else {
          addWelcomeMessage();
        }
        
        // Update sidebar
        renderSessions();
        
        // Scroll to bottom
        scrollToBottom();
        
      } catch (error) {
        console.error('Error loading session:', error);
        showToast('error', 'Failed to load chat session');
      }
    }

    async function deleteSession(sessionId, event) {
      event.stopPropagation();
      
      if (!confirm('Are you sure you want to delete this chat session?')) {
        return;
      }

      try {
        const response = await fetch(`/api/chat/sessions/${sessionId}/delete/`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete session');
        
        // If deleted session was current, create new one
        if (sessionId === AppState.currentSessionId) {
          await createNewSession();
        }
        
        // Reload sessions
        await loadSessions();
        
        showToast('success', 'Chat deleted');
        
      } catch (error) {
        console.error('Error deleting session:', error);
        showToast('error', 'Failed to delete chat');
      }
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // EVENT LISTENERS
    // ══════════════════════════════════════════════════════════════════════════════
    
    function setupEventListeners() {
      // Input handling
      elements.input.addEventListener('input', handleInputChange);
      elements.input.addEventListener('keydown', handleKeyDown);
      
      // Form submission
      elements.form.addEventListener('submit', handleSubmit);
      
      // File upload triggers
      elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
      elements.fileInput.addEventListener('change', handleFileSelect);
      
      // Theme toggle
      elements.themeToggle.addEventListener('click', toggleTheme);
      
      // New chat button
      elements.newChatBtn.addEventListener('click', createNewSession);
      
      // Logout
      elements.logoutBtn.addEventListener('click', handleLogout);
      
      // Mobile sidebar controls
      elements.mobileMenuToggle.addEventListener('click', openSidebar);
      elements.closeSidebar.addEventListener('click', closeSidebar);
      elements.sidebarOverlay.addEventListener('click', closeSidebar);
      
      // More options dropdown
      elements.moreOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.moreOptionsMenu.classList.toggle('active');
      });
      
      // Document count click
      elements.docCount.addEventListener('click', openDocumentManager);
      
      // Profile click
      elements.profileBtn.addEventListener('click', openProfileModal);
      elements.profileInfo.addEventListener('click', openProfileModal);
      
      // Chat title click to rename
      elements.chatTitle.addEventListener('click', () => {
        if (AppState.currentSessionId) {
          openRenameModal();
        }
      });
      
      // Rename modal enter key
      elements.newSessionName.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveSessionRename();
        }
      });
    }

    async function handleLogout() {
      try {
        await fetch('/api/logout/', { method: 'POST' });
        window.location.href = '/login/';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // INPUT HANDLING
    // ══════════════════════════════════════════════════════════════════════════════
    
    function handleInputChange() {
      // Auto-resize textarea
      elements.input.style.height = 'auto';
      elements.input.style.height = Math.min(elements.input.scrollHeight, 150) + 'px';
      
      // Update character count
      const length = elements.input.value.length;
      elements.charCount.textContent = length;
      
      // Update send button state
      elements.sendBtn.disabled = !elements.input.value.trim() || AppState.isProcessing;
    }

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!elements.sendBtn.disabled) {
          elements.form.dispatchEvent(new Event('submit'));
        }
      }
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // FILE UPLOAD
    // ══════════════════════════════════════════════════════════════════════════════

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        handleFiles(files);
      }
      e.target.value = ''; // Reset input
    }

    async function handleFiles(files) {
      // Ensure we have a session
      if (!AppState.currentSessionId) {
        await createNewSession();
      }

      for (const file of files) {
        await uploadFile(file);
      }
    }

    async function uploadFile(file) {
      if (!file) return;

      const fileSize = (file.size / (1024 * 1024)).toFixed(2);

      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_id', AppState.currentSessionId);

      try {
        const res = await fetch('/api/upload-document/', { 
          method: 'POST', 
          body: formData 
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || 'Upload failed');
        }

        const data = await res.json();

        // Add to state
        AppState.uploadedDocuments.push({
          id: data.document_id,
          name: file.name,
          size: fileSize,
          uploadedAt: new Date().toISOString()
        });

        // Update UI
        updateDocumentsList();

        // Add success message
        addMessage('ai', `✓ Document <strong>${file.name}</strong> (${fileSize} MB) uploaded successfully. You can now ask questions!`);

        // Show toast
        showToast('success', `${file.name} uploaded`);

      } catch (err) {
        addMessage('ai', `⚠️ Failed to process <strong>${file.name}</strong>: ${err.message}`);
        showToast('error', 'Upload failed');
      }
    }

    function updateDocumentsList() {
      if (AppState.uploadedDocuments.length === 0) {
        elements.uploadedDocs.classList.add('hidden');
        elements.docCount.classList.add('hidden');
        return;
      }

      elements.uploadedDocs.classList.remove('hidden');
      elements.docCount.classList.remove('hidden');
      elements.docCountNumber.textContent = AppState.uploadedDocuments.length;

      elements.docsList.innerHTML = AppState.uploadedDocuments.map((doc, index) => `
        <div class="document-badge group">
          <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z"/>
          </svg>
          <span class="max-w-[120px] md:max-w-[200px] truncate">${escapeHtml(doc.name)}</span>
          <span class="hidden md:inline text-xs opacity-70">${doc.size}MB</span>
        </div>
      `).join('');
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // MESSAGE HANDLING
    // ══════════════════════════════════════════════════════════════════════════════
    
    function addWelcomeMessage() {
      const welcomeDiv = document.createElement('div');
      welcomeDiv.className = 'flex items-start gap-2 md:gap-4 animate-fade-in';
      welcomeDiv.innerHTML = `
        <div class="w-9 h-9 md:w-11 md:h-11 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex-shrink-0 flex items-center justify-center text-white shadow-md">
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div class="flex-1 bg-white dark:bg-slate-800 px-4 py-3 md:px-6 md:py-4 rounded-2xl rounded-tl-md shadow-sm border border-slate-100 dark:border-slate-700">
          <p class="text-slate-800 dark:text-slate-200 text-sm md:text-base mb-1 md:mb-2">Welcome! I'm your AI Document Assistant.</p>
          <p class="text-xs md:text-sm text-slate-600 dark:text-slate-400">
            Upload your documents and start asking questions to get instant, accurate answers.
          </p>
        </div>
      `;
      elements.messages.appendChild(welcomeDiv);
    }

    function addMessage(role, content, options = {}) {
      const isUser = role === 'user';
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex items-start gap-2 md:gap-4 animate-fade-in ${isUser ? 'justify-end' : ''}`;

      const timestamp = new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });

      const avatar = isUser
        ? `<div class="w-9 h-9 md:w-11 md:h-11 rounded-xl bg-gradient-to-br from-slate-300 to-slate-400 dark:from-slate-600 dark:to-slate-700 flex items-center justify-center text-slate-700 dark:text-slate-200 font-semibold shadow-md flex-shrink-0">
             <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
             </svg>
           </div>`
        : `<div class="w-9 h-9 md:w-11 md:h-11 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white shadow-md flex-shrink-0">
             <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
             </svg>
           </div>`;

      const bubbleClass = isUser
        ? 'bg-gradient-to-br from-blue-600 to-purple-600 text-white'
        : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 border border-slate-100 dark:border-slate-700';

      const bubble = `
        <div class="message-bubble">
          <div class="${bubbleClass} px-4 py-3 md:px-6 md:py-4 rounded-2xl ${isUser ? 'rounded-tr-md' : 'rounded-tl-md'} shadow-sm">
            <div class="prose prose-sm max-w-none ${isUser ? 'prose-invert' : 'dark:prose-invert'} text-sm md:text-base">
              ${content.replace(/\n/g, '<br>')}
            </div>
          </div>
          <div class="mt-1 md:mt-2 px-2 flex items-center gap-2 text-xs ${isUser ? 'justify-end' : ''} text-slate-400 dark:text-slate-500">
            <span>${timestamp}</span>
            ${!isUser && !options.isTyping ? `
              <button onclick="copyMessage(this)" class="hover:text-slate-600 dark:hover:text-slate-300 transition">
                <svg class="w-3 h-3 md:w-3.5 md:h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
              </button>
            ` : ''}
          </div>
        </div>
      `;

      messageDiv.innerHTML = isUser ? `${bubble}${avatar}` : `${avatar}${bubble}`;
      elements.messages.appendChild(messageDiv);
      scrollToBottom();

      return messageDiv;
    }

    function addTypingIndicator() {
      const div = document.createElement('div');
      div.id = 'typing-indicator';
      div.className = 'flex items-start gap-2 md:gap-4 animate-fade-in';
      div.innerHTML = `
        <div class="w-9 h-9 md:w-11 md:h-11 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white shadow-md flex-shrink-0">
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <div class="bg-white dark:bg-slate-800 px-4 py-3 md:px-6 md:py-4 rounded-2xl rounded-tl-md shadow-sm border border-slate-100 dark:border-slate-700">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      elements.messages.appendChild(div);
      scrollToBottom();
      return div;
    }

    window.copyMessage = function(button) {
      const messageContent = button.closest('.message-bubble').querySelector('.prose').textContent;
      navigator.clipboard.writeText(messageContent).then(() => {
        showToast('success', 'Message copied');
      });
    };

    function clearMessages() {
      elements.messages.innerHTML = '';
    }

    function scrollToBottom() {
      setTimeout(() => {
        elements.messages.scrollTop = elements.messages.scrollHeight;
      }, 100);
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // FORM SUBMISSION
    // ══════════════════════════════════════════════════════════════════════════════
    
    async function handleSubmit(e) {
      e.preventDefault();
      
      const text = elements.input.value.trim();
      if (!text || AppState.isProcessing) return;

      // Create session if doesn't exist
      if (!AppState.currentSessionId) {
        await createNewSession();
      }

      AppState.isProcessing = true;

      // Add user message
      addMessage('user', text);

      // Clear and reset input
      elements.input.value = '';
      elements.input.style.height = 'auto';
      elements.charCount.textContent = '0';
      elements.sendBtn.disabled = true;

      // Add typing indicator
      const typingIndicator = addTypingIndicator();

      try {
        const response = await fetch('/api/chat/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            question: text,
            session_id: AppState.currentSessionId
          })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        
        // Update session ID if created
        if (data.session_id) {
          AppState.currentSessionId = data.session_id;
        }
        
        // Remove typing indicator
        typingIndicator.remove();

        // Add AI response
        addMessage('ai', data.answer || 'I apologize, but I couldn\'t generate a response. Please try again.');

        // Reload sessions to update
        await loadSessions();

      } catch (err) {
        typingIndicator.remove();
        addMessage('ai', `⚠️ <strong>Error:</strong> ${err.message}. Please try again.`);
        showToast('error', 'Failed to get response');
      } finally {
        AppState.isProcessing = false;
        elements.input.focus();
      }
    }

    // ══════════════════════════════════════════════════════════════════════════════
    // UTILITY FUNCTIONS
    // ══════════════════════════════════════════════════════════════════════════════
    
    function toggleTheme() {
      AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
      applyTheme(AppState.theme);
      localStorage.setItem('theme', AppState.theme);
    }

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }

    function clearConversation() {
      if (!confirm('Clear this conversation and create a new chat?')) {
        return;
      }

      elements.moreOptionsMenu.classList.remove('active');
      createNewSession();
    }

    function showToast(type, message) {
      const icons = {
        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
      };

      const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
      };

      elements.toastIcon.innerHTML = icons[type];
      elements.toastMessage.textContent = message;
      elements.toast.className = `fixed top-4 right-4 left-4 md:left-auto md:top-6 md:right-6 ${colors[type]} text-white px-4 py-3 md:px-6 md:py-3 rounded-xl shadow-2xl z-[60] animate-slide-up flex items-center gap-3`;

      setTimeout(() => {
        elements.toast.classList.add('hidden');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Now';
      if (diffMins < 60) return `${diffMins}m`;
      if (diffHours < 24) return `${diffHours}h`;
      if (diffDays < 7) return `${diffDays}d`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // ══════════════════════════════════════════════════════════════════════════════
    // INITIALIZE APP
    // ══════════════════════════════════════════════════════════════════════════════
    
    init();
  </script>
</body>
</html>